name: Auto-Deploy FastAPI Backend to Hostinger

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Create production deployment files
      run: |
        mkdir -p deploy_files
        
        # Create production startup script
        cat > deploy_files/start_production.py << 'EOF'
        #!/usr/bin/env python3
        """
        Production startup script for Legatoo FastAPI Backend
        """
        import os
        import sys
        import uvicorn
        from pathlib import Path
        
        # Add the project root to Python path
        project_root = Path(__file__).parent
        sys.path.insert(0, str(project_root))
        
        # Add user site-packages to Python path for user-installed packages
        import site
        user_site = site.getusersitepackages()
        if user_site not in sys.path:
            sys.path.insert(0, user_site)
        
        # Set production environment variables
        os.environ.setdefault('ENVIRONMENT', 'production')
        os.environ.setdefault('LOG_LEVEL', 'INFO')
        
        if __name__ == "__main__":
            print("üöÄ Starting Legatoo FastAPI Backend - Production Mode")
            print("üìã Deploying actual FastAPI backend with all endpoints")
            print("üîÑ Deployment triggered by: GitHub Actions Push")
            print("üåê API Documentation: https://legatoo.westlinktowing.com/api/docs")
            print("üìä Swagger UI: https://legatoo.westlinktowing.com/api/swagger.html")
            
            # Start the FastAPI application
            uvicorn.run(
                "app.main:app",
                host="0.0.0.0",
                port=8000,
                reload=False,
                workers=1,
                log_level="info"
            )
        EOF
        
        # Create production deployment script
        cat > deploy_files/deploy_production.sh << 'EOF'
        #!/bin/bash
        echo "üöÄ Starting Production FastAPI Backend Deployment..."
        echo "üìÖ Deployment Time: $(date)"
        echo "üîÑ Triggered by: Push to Repository"
        
        cd /home/$USER/legatoo_backend
        
        # Stop old processes
        echo "üõë Stopping old backend processes..."
        pkill -f "start_production.py" || true
        pkill -f "exact_routes_backend.py" || true
        pkill -f "deploy_backend.py" || true
        pkill -f "run_fastapi.py" || true
        pkill -f "uvicorn" || true
        
        # Install Python 3.13
        echo "üêç Installing Python 3.13..."
        
        # Update system packages
        sudo apt-get update -y
        
        # Install dependencies for Python compilation
        sudo apt-get install -y build-essential zlib1g-dev libncurses5-dev libgdbm-dev libnss3-dev libssl-dev libreadline-dev libffi-dev libsqlite3-dev wget libbz2-dev
        
        # Download and compile Python 3.13
        cd /tmp
        wget https://www.python.org/ftp/python/3.13.0/Python-3.13.0.tgz
        tar -xf Python-3.13.0.tgz
        cd Python-3.13.0
        
        # Configure and compile Python 3.13
        ./configure --enable-optimizations --prefix=/usr/local/python3.13
        make -j $(nproc)
        sudo make altinstall
        
        # Create symlink for python3.13
        sudo ln -sf /usr/local/python3.13/bin/python3.13 /usr/local/bin/python3.13
        sudo ln -sf /usr/local/python3.13/bin/pip3.13 /usr/local/bin/pip3.13
        
        # Verify Python 3.13 installation
        echo "‚úÖ Verifying Python 3.13 installation..."
        python3.13 --version
        pip3.13 --version
        
        # Install Python dependencies with Python 3.13
        echo "üì¶ Installing Python dependencies with Python 3.13..."
        pip3.13 install --user -r requirements.txt
        
        # Verify installation
        echo "‚úÖ Verifying installation..."
        python3.13 -c "import fastapi, uvicorn, sqlalchemy, aiofiles; print('All dependencies installed successfully!')"
        
        # Create database if it doesn't exist
        echo "üóÑÔ∏è Initializing database..."
        python3.13 -c "
        import asyncio
        from app.db.database import create_tables
        asyncio.run(create_tables())
        print('Database tables created successfully!')
        "
        
        # Start production backend with Python 3.13
        echo "‚ñ∂Ô∏è Starting production FastAPI backend with Python 3.13..."
        nohup python3.13 start_production.py > production.log 2>&1 &
        
        # Wait for startup
        sleep 5
        
        # Test backend health
        echo "üß™ Testing backend health..."
        if curl -s http://localhost:8000/health > /dev/null; then
            echo "‚úÖ FastAPI Backend deployed successfully!"
            echo "üåê API: https://legatoo.westlinktowing.com/api"
            echo "üìö Swagger UI: https://legatoo.westlinktowing.com/api/swagger.html"
            echo "üìñ API Docs: https://legatoo.westlinktowing.com/api/docs"
            echo "üîê Auth Endpoints: https://legatoo.westlinktowing.com/api/v1/auth/"
        else
            echo "‚ùå Backend health check failed"
            echo "üìã Checking logs..."
            tail -20 production.log
            exit 1
        fi
        EOF
        chmod +x deploy_files/deploy_production.sh

    - name: Upload files to Hostinger
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.HOSTINGER_HOST }}
        username: ${{ secrets.HOSTINGER_USERNAME }}
        password: ${{ secrets.HOSTINGER_PASSWORD }}
        port: ${{ secrets.HOSTINGER_PORT }}
        source: "deploy_files/*"
        target: "/home/${{ secrets.HOSTINGER_USERNAME }}/legatoo_backend/"
        strip_components: 1

    - name: Execute production deployment
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.HOSTINGER_HOST }}
        username: ${{ secrets.HOSTINGER_USERNAME }}
        password: ${{ secrets.HOSTINGER_PASSWORD }}
        port: ${{ secrets.HOSTINGER_PORT }}
        timeout: 60s
        command_timeout: 60s
        script: |
          cd /home/${{ secrets.HOSTINGER_USERNAME }}/legatoo_backend
          chmod +x deploy_production.sh
          ./deploy_production.sh