name: Backend CI/CD Deployment

# تشغيل عند الدفع (Push) إلى الفرع الرئيسي
on:
  push:
    branches:
      - main 

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # 1. سحب كود الباك إند (المستودع الحالي)
      - name: Checkout Backend Code
        uses: actions/checkout@v3
          
      # ----------------------------------------
      # 2. التحقق من وجود مفتاح SSH
      # ----------------------------------------
      - name: Verify SSH Key
        run: |
          if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            echo "❌ Error: SSH_PRIVATE_KEY secret is not set!"
            echo "Please add your SSH private key to repository secrets."
            exit 1
          else
            echo "✅ SSH_PRIVATE_KEY is configured"
            echo "Key length: $(echo '${{ secrets.SSH_PRIVATE_KEY }}' | wc -c) characters"
          fi
      
      # ----------------------------------------
      # 3. النشر عبر SSH (إلى الخادم)
      # ----------------------------------------
      - name: Deploy Backend via SSH
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: 72.60.197.118 
          username: root       
          key: ${{ secrets.SSH_PRIVATE_KEY }} # المفتاح الخاص المخزن كـ Secret
          port: 22
          timeout: 30s
          script: |
            echo "Starting Backend Deployment..."
            
            # --- تحديث ونشر الواجهة الخلفية (Backend) ---
            # نقل كود الباك إند إلى مجلد العمل النهائي
            rsync -avz --delete /github/workspace/ /root/legatoo_backend/
            
            # تثبيت حزم Python جديدة (إذا لزم الأمر)
            echo "Installing Python dependencies..."
            source /root/legatoo_backend/venv/bin/activate
            pip install -r /root/legatoo_backend/requirements.txt
            
            # إعادة تشغيل خدمة FastAPI
            sudo systemctl restart fastapi 
            
            echo "Backend Deployment Complete."