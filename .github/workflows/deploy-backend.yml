name: Auto-Deploy FastAPI Backend to Hostinger

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Create production deployment files
      run: |
        mkdir -p deploy_files
        
        # Create production startup script
        cat > deploy_files/start_production.py << 'EOF'
        #!/usr/bin/env python3
        """
        Production startup script for Legatoo FastAPI Backend
        """
        import os
        import sys
        import uvicorn
        from pathlib import Path
        
        # Add the project root to Python path
        project_root = Path(__file__).parent
        sys.path.insert(0, str(project_root))
        
        # Add user site-packages to Python path for user-installed packages
        import site
        user_site = site.getusersitepackages()
        if user_site not in sys.path:
            sys.path.insert(0, user_site)
        
        # Set production environment variables
        os.environ.setdefault('ENVIRONMENT', 'production')
        os.environ.setdefault('LOG_LEVEL', 'INFO')
        
        if __name__ == "__main__":
            print("üöÄ Starting Legatoo FastAPI Backend - Production Mode")
            print("üìã Deploying actual FastAPI backend with all endpoints")
            print("üîÑ Deployment triggered by: GitHub Actions Push")
            print("üåê API Documentation: https://legatoo.westlinktowing.com/api/docs")
            print("üìä Swagger UI: https://legatoo.westlinktowing.com/api/swagger.html")
            
            # Start the FastAPI application
            uvicorn.run(
                "app.main:app",
                host="0.0.0.0",
                port=8000,
                reload=False,
                workers=1,
                log_level="info"
            )
        EOF
        
        # Create production deployment script
        cat > deploy_files/deploy_production.sh << 'EOF'
        #!/bin/bash
        echo "üöÄ Starting Production FastAPI Backend Deployment..."
        echo "üìÖ Deployment Time: $(date)"
        echo "üîÑ Triggered by: Push to Repository"
        
        cd /home/$USER/legatoo_backend
        
        # Stop old processes
        echo "üõë Stopping old backend processes..."
        pkill -f "start_production.py" || true
        pkill -f "exact_routes_backend.py" || true
        pkill -f "deploy_backend.py" || true
        pkill -f "run_fastapi.py" || true
        pkill -f "uvicorn" || true
        
        # Check Python version and install dependencies
        echo "üêç Checking Python installation..."
        python3 --version
        
        # Try different pip commands
        echo "üì¶ Installing Python dependencies..."
        if command -v pip3 &> /dev/null; then
            echo "Using pip3..."
            pip3 install --upgrade pip
            pip3 install -r requirements.txt
        elif command -v pip &> /dev/null; then
            echo "Using pip..."
            pip install --upgrade pip
            pip install -r requirements.txt
        elif python3 -m pip --version &> /dev/null; then
            echo "Using python3 -m pip..."
            python3 -m pip install --upgrade pip
            python3 -m pip install -r requirements.txt
        else
            echo "‚ùå No pip command found. Installing pip..."
            curl https://bootstrap.pypa.io/get-pip.py -o get-pip.py
            python3 get-pip.py --user
            export PATH="$HOME/.local/bin:$PATH"
            python3 -m pip install --user --upgrade pip
            python3 -m pip install --user -r requirements.txt
        fi
        
        # Verify installation
        echo "‚úÖ Verifying installation..."
        export PYTHONPATH="$HOME/.local/lib/python3.6/site-packages:$PYTHONPATH"
        python3 -c "import fastapi, uvicorn, sqlalchemy; print('All dependencies installed successfully!')"
        
        # Create database if it doesn't exist
        echo "üóÑÔ∏è Initializing database..."
        export PYTHONPATH="$HOME/.local/lib/python3.6/site-packages:$PYTHONPATH"
        python3 -c "
        import asyncio
        from app.db.database import create_tables
        asyncio.run(create_tables())
        print('Database tables created successfully!')
        "
        
        # Start production backend
        echo "‚ñ∂Ô∏è Starting production FastAPI backend..."
        nohup python3 start_production.py > production.log 2>&1 &
        
        # Wait for startup
        sleep 5
        
        # Test backend health
        echo "üß™ Testing backend health..."
        if curl -s http://localhost:8000/health > /dev/null; then
            echo "‚úÖ FastAPI Backend deployed successfully!"
            echo "üåê API: https://legatoo.westlinktowing.com/api"
            echo "üìö Swagger UI: https://legatoo.westlinktowing.com/api/swagger.html"
            echo "üìñ API Docs: https://legatoo.westlinktowing.com/api/docs"
            echo "üîê Auth Endpoints: https://legatoo.westlinktowing.com/api/v1/auth/"
        else
            echo "‚ùå Backend health check failed"
            echo "üìã Checking logs..."
            tail -20 production.log
            exit 1
        fi
        EOF
        chmod +x deploy_files/deploy_production.sh

    - name: Upload files to Hostinger
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.HOSTINGER_HOST }}
        username: ${{ secrets.HOSTINGER_USERNAME }}
        password: ${{ secrets.HOSTINGER_PASSWORD }}
        port: ${{ secrets.HOSTINGER_PORT }}
        source: "deploy_files/*"
        target: "/home/${{ secrets.HOSTINGER_USERNAME }}/legatoo_backend/"
        strip_components: 1

    - name: Execute production deployment
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.HOSTINGER_HOST }}
        username: ${{ secrets.HOSTINGER_USERNAME }}
        password: ${{ secrets.HOSTINGER_PASSWORD }}
        port: ${{ secrets.HOSTINGER_PORT }}
        timeout: 60s
        command_timeout: 60s
        script: |
          cd /home/${{ secrets.HOSTINGER_USERNAME }}/legatoo_backend
          chmod +x deploy_production.sh
          ./deploy_production.sh