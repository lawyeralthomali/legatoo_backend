name: Deploy Backend via SSH/RSYNC

on:
  push:
    branches: [ main ] # ูุชู ุงูุชุดุบูู ุนูุฏ ุงูุฑูุน ุนูู ุงููุฑุน ุงูุฑุฆูุณู

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Backend Code
        uses: actions/checkout@v4
        # ููุงุญุธุฉ: ูุฐุง ุงููุณุชูุฏุน ูุญุชูู ุนูู ุงูุจุงู ุฅูุฏ ููุท

      # --- ุงููุดุฑ ุนุจุฑ SSH ูุฅุนุงุฏุฉ ุชุดุบูู ุงูุฎุฏูุงุช ---
      - name: Deploy Backend and Restart Services
        uses: appleboy/ssh-action@v0.1.7 # ุฃุฏุงุฉ ุงููุดุฑ ุงูุขููุฉ ุนุจุฑ SSH
        with:
          host: 72.60.197.118 # ๐ IP ุฎุงุฏูู (VPS)
          username: root       # ุงุณู ุงููุณุชุฎุฏู ุงูุฐู ุฃุถูุช ูู ููุชุงุญ SSH
          key: ${{ secrets.SSH_PRIVATE_KEY }} # ุงูููุชุงุญ ุงูุฎุงุต ุงููุฎุฒู ูู GitHub
          script: |
            # 1. ููู ูููุงุช ุงูุจุงู ุฅูุฏ ุงูุฌุฏูุฏุฉ (ูุณุชุฎุฏู RSYNC ููููู ุงููุนุงู)
            # ุงูููู ูู ูุฌูุฏ ุงูููุฏ ุฅูู ูุณุงุฑ ุงูุจุงู ุฅูุฏ
            rsync -avz --delete ./ /root/legatoo_backend/
            
            # 2. ุชุซุจูุช ุญุฒู Python ุฌุฏูุฏุฉ (ุฅุฐุง ูุฒู ุงูุฃูุฑ)
            echo "Installing Python dependencies..."
            source /root/legatoo_backend/venv/bin/activate
            pip install -r /root/legatoo_backend/requirements.txt
            
            # 3. ุฅุนุงุฏุฉ ุชุดุบูู ุฎุฏูุฉ FastAPI
            sudo systemctl restart fastapi # ุฅุนุงุฏุฉ ุชุดุบูู ุงูุจุงู ุฅูุฏ ูุชุญููู ุงูุชุบููุฑุงุช