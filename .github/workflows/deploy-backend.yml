name: Deploy Backend via SSH/RSYNC
#test
on:
  push:
    branches: [ main ] # يتم التشغيل عند الرفع على الفرع الرئيسي

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Backend Code
        uses: actions/checkout@v4
        # ملاحظة: هذا المستودع يحتوي على الباك إند فقط

      # --- النشر عبر SSH وإعادة تشغيل الخدمات ---
      - name: Deploy Backend and Restart Services
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: 72.60.197.118
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # 1. Navigate to the backend directory
            cd /root/legatoo_backend

            # 2. Pull the latest code (Assuming the runner copied the files via actions/checkout)
            # * ملاحظة: إذا كان هذا هو الإعداد الوحيد، فغالباً يجب عليك سحب الكود يدوياً أو استخدام rsync لنقل الملفات.
            # * بما أن الكود نُشر مسبقاً، سنركز على إعادة تشغيل الخدمة.
            
            # 3. تثبيت أي متطلبات جديدة (إذا كان هناك تغيير في requirements.txt)
            source venv/bin/activate
            pip install -r requirements.txt || true # تجاهل الفشل إذا لم يكن هناك ملف متطلبات
            deactivate

            # 4. إعادة تشغيل خدمة الواجهة الخلفية لتطبيق الكود الجديد
            echo "Restarting FastAPI service..."
            sudo systemctl restart fastapi.service
            
            # 5. التحقق من حالة الصحة (Health Check) عبر Nginx
            echo "Deployment completed. Checking service health..."
            # نستخدم curl الداخلي على المنفذ 8000 مباشرة للتحقق، وليس عبر Nginx
            curl -s http://127.0.0.1:8000/health || echo "Health check failed"