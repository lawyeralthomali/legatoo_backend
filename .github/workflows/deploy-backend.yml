name: Full Stack CI/CD Deployment

# ØªØ´ØºÙŠÙ„ Ø¹Ù†Ø¯ Ø§Ù„Ø¯ÙØ¹ (Push) Ø¥Ù„Ù‰ Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
on:
  push:
    branches:
      - main 

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # 1. Ø³Ø­Ø¨ ÙƒÙˆØ¯ Ø§Ù„Ø¨Ø§Ùƒ Ø¥Ù†Ø¯ (Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ)
      - name: Checkout Backend Code
        uses: actions/checkout@v3
        with:
          # Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù‡Ùˆ ./
          path: backend 

      # 2. Ø³Ø­Ø¨ ÙƒÙˆØ¯ Ø§Ù„ÙØ±ÙˆÙ†Øª Ø¥Ù†Ø¯ (Ù…Ù† Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ù…Ù†ÙØµÙ„)
      # Ù‡Ø°Ø§ ÙŠØªØ·Ù„Ø¨ Ø¥Ø¹Ø¯Ø§Ø¯ Ø³Ø±ÙŠ (Secret) Ø¨Ø§Ø³Ù… FASTAPI_REPO_TOKEN
      - name: Checkout Frontend Code
        uses: actions/checkout@v3
        with:
          repository: lawyeralthomali/legatoo # ğŸ›‘ Ø¹Ù†ÙˆØ§Ù† Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø£Ù…Ø§Ù…ÙŠØ©
          token: ${{ secrets.FASTAPI_REPO_TOKEN }} 
          path: frontend 

      # ----------------------------------------
      # 3. Ø¨Ù†Ø§Ø¡ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø£Ù…Ø§Ù…ÙŠØ© ÙˆØªØµØ¯ÙŠØ±Ù‡Ø§
      # ----------------------------------------
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18' 

      - name: Install Frontend Dependencies and Build
        run: |
          cd frontend
          npm install
          # ğŸ›‘ Ù‡Ø°Ø§ Ø§Ù„Ø£Ù…Ø± ÙŠÙ†Ø´Ø¦ Ù…Ø¬Ù„Ø¯ 'out' Ø¨Ø¹Ø¯ ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØµØ¯ÙŠØ± Ø§Ù„Ø«Ø§Ø¨Øª ğŸ›‘
          npm run deploy
          
      # ----------------------------------------
      # 4. Ø§Ù„Ù†Ø´Ø± Ø¹Ø¨Ø± SSH (Ø¥Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù…)
      # ----------------------------------------
      - name: Deploy and Restart Services via SSH
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: 72.60.197.118 
          username: root       
          key: ${{ secrets.SSH_PRIVATE_KEY }} # Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø®Ø§Øµ Ø§Ù„Ù…Ø®Ø²Ù† ÙƒÙ€ Secret
          script: |
            echo "Starting Unified Deployment..."
            
            # --- 1. ØªØ­Ø¯ÙŠØ« ÙˆÙ†Ø´Ø± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø£Ù…Ø§Ù…ÙŠØ© (Frontend) ---
            # Ø­Ø°Ù Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ÙˆÙ†Ù‚Ù„ Ù…Ø­ØªÙˆÙŠØ§Øª Ù…Ø¬Ù„Ø¯ 'out' Ø¥Ù„Ù‰ Ù…Ø³Ø§Ø± Nginx
            # Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ø·Ù„Ù‚ Ù„Ù…Ù„Ù Ø§Ù„Ø¨Ù†Ø§Ø¡ ÙÙŠ Ø¨ÙŠØ¦Ø© Ø§Ù„Ù€ Action Ù‡Ùˆ /github/workspace/frontend/out/
            sudo rsync -avz --delete ./frontend/out/ /var/www/legatoo_frontend/
            sudo chown -R www-data:www-data /var/www/legatoo_frontend
            
            # --- 2. ØªØ­Ø¯ÙŠØ« ÙˆÙ†Ø´Ø± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø®Ù„ÙÙŠØ© (Backend) ---
            # Ù†Ù‚Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø¨Ø§Ùƒ Ø¥Ù†Ø¯ Ø¥Ù„Ù‰ Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
            rsync -avz --delete ./backend/ /root/legatoo_backend/
            
            # 3. ØªØ«Ø¨ÙŠØª Ø­Ø²Ù… Python Ø¬Ø¯ÙŠØ¯Ø© (Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±)
            echo "Installing Python dependencies..."
            source /root/legatoo_backend/venv/bin/activate
            pip install -r /root/legatoo_backend/requirements.txt
            
            # ğŸ›‘ 4. Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø®Ø¯Ù…Ø© FastAPI (Ù„ØªØ·Ø¨ÙŠÙ‚ ÙƒÙˆØ¯ CORS Ø§Ù„Ø¬Ø¯ÙŠØ¯) ğŸ›‘
            sudo systemctl restart fastapi 
            
            # 5. Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Nginx (Ù„Ø¶Ù…Ø§Ù† Ø±Ø¤ÙŠØ© Ù…Ù„ÙØ§Øª Ø§Ù„ÙØ±ÙˆÙ†Øª Ø¥Ù†Ø¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©)
            sudo systemctl reload nginx
            echo "Deployment Complete."