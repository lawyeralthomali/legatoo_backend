name: Deploy Backend via SSH/RSYNC
#test
on:
  push:
    branches: [ main ] # يتم التشغيل عند الرفع على الفرع الرئيسي

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Backend Code
        uses: actions/checkout@v4
        # ملاحظة: هذا المستودع يحتوي على الباك إند فقط

      # --- النشر عبر SSH وإعادة تشغيل الخدمات ---
      - name: Deploy Backend and Restart Services
        uses: appleboy/ssh-action@v0.1.7 # أداة النشر الآمنة عبر SSH
        with:
          host: 72.60.197.118 # 🛑 IP خادمك (VPS)
          username: root       # اسم المستخدم الذي أضفت له مفتاح SSH
          key: ${{ secrets.SSH_PRIVATE_KEY }} # المفتاح الخاص المخزن في GitHub
          script: |
            # 1. Navigate to the backend directory
            cd /root/legatoo_backend
            
            # 2. Pull latest code from git
            git pull origin main
            
            # 3. Make deployment script executable and run it
            chmod +x deploy_files/deploy_simple.sh
            ./deploy_files/deploy_simple.sh
            
            # 4. Verify deployment
            echo "Deployment completed. Checking status..."
            sleep 5
            curl -s http://localhost:8000/health || echo "Health check failed"