# ğŸ¨ Visual Flow Diagram: `/api/v1/search/similar-laws`

**Created**: October 9, 2025  
**Purpose**: Visual representation of the complete search flow

---

## ğŸŒŠ Complete Request-Response Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚                         ğŸ‘¤ USER/CLIENT APPLICATION                          â”‚
â”‚                                                                             â”‚
â”‚  ğŸ” Search Query: "ÙØ³Ø® Ø¹Ù‚Ø¯ Ø§Ù„Ø¹Ù…Ù„"                                           â”‚
â”‚  ğŸ“Š Parameters: top_k=10, threshold=0.7                                     â”‚
â”‚  ğŸ” Auth: JWT Token                                                         â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â”‚ HTTP POST Request
                                â”‚ /api/v1/search/similar-laws
                                â”‚ Authorization: Bearer <token>
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚                    ğŸšª STEP 1: API GATEWAY & MIDDLEWARE                      â”‚
â”‚                    File: app/routes/search_router.py                        â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚  1.1 ğŸ” JWT Authentication (get_current_user)                        â”‚ â”‚
â”‚  â”‚      â”œâ”€ Extract token from header                                    â”‚ â”‚
â”‚  â”‚      â”œâ”€ Verify signature                                             â”‚ â”‚
â”‚  â”‚      â”œâ”€ Check expiration                                             â”‚ â”‚
â”‚  â”‚      â””â”€ Extract user_id: "user123"                                   â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚  1.2 âœ… Input Validation (FastAPI)                                   â”‚ â”‚
â”‚  â”‚      â”œâ”€ query: min 3 chars âœ“                                         â”‚ â”‚
â”‚  â”‚      â”œâ”€ top_k: 1-100 âœ“                                               â”‚ â”‚
â”‚  â”‚      â”œâ”€ threshold: 0.0-1.0 âœ“                                         â”‚ â”‚
â”‚  â”‚      â””â”€ Optional filters âœ“                                           â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚  1.3 ğŸ“¦ Build Filter Dictionary                                      â”‚ â”‚
â”‚  â”‚      filters = {                                                     â”‚ â”‚
â”‚  â”‚        'jurisdiction': jurisdiction,                                 â”‚ â”‚
â”‚  â”‚        'law_source_id': law_source_id                                â”‚ â”‚
â”‚  â”‚      }                                                                â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â”‚ Call Service Layer
                                â”‚ search_service.find_similar_laws(...)
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚               ğŸ§  STEP 2: SEARCH SERVICE (Main Logic)                        â”‚
â”‚               File: app/services/arabic_legal_search_service.py             â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚  2.1 ğŸ’¾ Check Cache                                                  â”‚ â”‚
â”‚  â”‚      cache_key = "laws_ÙØ³Ø® Ø¹Ù‚Ø¯ Ø§Ù„Ø¹Ù…Ù„_10_0.7_None"                   â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚      if cache_key in _query_cache:                                   â”‚ â”‚
â”‚  â”‚          ğŸ¯ CACHE HIT! Return instantly (20ms)                       â”‚ â”‚
â”‚  â”‚          â””â”€ Skip to Step 9                                           â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚      else:                                                            â”‚ â”‚
â”‚  â”‚          âŒ CACHE MISS - Continue to next step                       â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚  2.2 ğŸ¤– Call Embedding Service                                       â”‚ â”‚
â”‚  â”‚      query_embedding = embedding_service.encode_text(query)          â”‚ â”‚
â”‚  â”‚      â†“                                                                â”‚ â”‚
â”‚  â”‚      Go to STEP 3 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚               ğŸ§¬ STEP 3: EMBEDDING SERVICE (AI Processing)                  â”‚
â”‚               File: app/services/arabic_legal_embedding_service.py          â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚  3.1 ğŸ’¾ Check Embedding Cache                                        â”‚ â”‚
â”‚  â”‚      if "ÙØ³Ø® Ø¹Ù‚Ø¯ Ø§Ù„Ø¹Ù…Ù„" in _embedding_cache:                         â”‚ â”‚
â”‚  â”‚          Return cached embedding (instant)                           â”‚ â”‚
â”‚  â”‚      else:                                                            â”‚ â”‚
â”‚  â”‚          Continue to AI model                                        â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚  3.2 ğŸ”§ Ensure Model is Loaded                                       â”‚ â”‚
â”‚  â”‚      if model is None:                                               â”‚ â”‚
â”‚  â”‚          Load paraphrase-multilingual-mpnet-base-v2                  â”‚ â”‚
â”‚  â”‚          (278M parameters, 768 dimensions)                           â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚  3.3 âœ‚ï¸ Truncate Text if Needed                                      â”‚ â”‚
â”‚  â”‚      max_length = 512 tokens (~2048 chars)                           â”‚ â”‚
â”‚  â”‚      if len(text) > max_length:                                      â”‚ â”‚
â”‚  â”‚          text = text[:max_length]                                    â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚  3.4 ğŸ¤– Generate Embedding with AI Model                             â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚      Input: "ÙØ³Ø® Ø¹Ù‚Ø¯ Ø§Ù„Ø¹Ù…Ù„"                                          â”‚ â”‚
â”‚  â”‚         â†“                                                             â”‚ â”‚
â”‚  â”‚      Tokenization                                                     â”‚ â”‚
â”‚  â”‚         â†“                                                             â”‚ â”‚
â”‚  â”‚      [101, 1234, 5678, ..., 102]  (Token IDs)                       â”‚ â”‚
â”‚  â”‚         â†“                                                             â”‚ â”‚
â”‚  â”‚      Transformer Model (12 layers, 768 hidden)                       â”‚ â”‚
â”‚  â”‚         â†“                                                             â”‚ â”‚
â”‚  â”‚      Mean Pooling                                                     â”‚ â”‚
â”‚  â”‚         â†“                                                             â”‚ â”‚
â”‚  â”‚      Output: [0.123, -0.456, 0.789, ..., 0.234]                     â”‚ â”‚
â”‚  â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚ â”‚
â”‚  â”‚                     768 dimensions                                    â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚      Time: 50-100ms (CPU), 10-20ms (GPU)                            â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚  3.5 ğŸ’¾ Cache & Return                                               â”‚ â”‚
â”‚  â”‚      _embedding_cache["ÙØ³Ø® Ø¹Ù‚Ø¯ Ø§Ù„Ø¹Ù…Ù„"] = embedding                   â”‚ â”‚
â”‚  â”‚      return embedding                                                 â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â”‚ Return query_embedding
                                â”‚ [768 floats]
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚               ğŸ“Š STEP 4: DATABASE QUERY                                     â”‚
â”‚               File: app/services/arabic_legal_search_service.py             â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚  4.1 ğŸ”¨ Build SQL Query                                              â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚      SELECT * FROM knowledge_chunk                                   â”‚ â”‚
â”‚  â”‚      WHERE embedding_vector IS NOT NULL                              â”‚ â”‚
â”‚  â”‚        AND embedding_vector != ''                                    â”‚ â”‚
â”‚  â”‚        AND law_source_id IS NOT NULL                                 â”‚ â”‚
â”‚  â”‚        [+ jurisdiction filter if provided]                           â”‚ â”‚
â”‚  â”‚        [+ law_source_id filter if provided]                          â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚  4.2 ğŸ’¾ Execute Query                                                â”‚ â”‚
â”‚  â”‚      result = await db.execute(query_builder)                        â”‚ â”‚
â”‚  â”‚      chunks = result.scalars().all()                                 â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚      ğŸ“Š Found 600 law chunks with embeddings                         â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â”‚ Return chunks[]
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚               ğŸ§® STEP 5: CALCULATE SIMILARITIES                             â”‚
â”‚               File: app/services/arabic_legal_search_service.py             â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚  5.1 ğŸ” Loop Through All Chunks                                      â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚      for chunk in chunks:  # 600 iterations                          â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚          # Parse stored embedding                                    â”‚ â”‚
â”‚  â”‚          chunk_embedding = json.loads(chunk.embedding_vector)        â”‚ â”‚
â”‚  â”‚          chunk_embedding = np.array(chunk_embedding)                 â”‚ â”‚
â”‚  â”‚          # [0.15, -0.48, 0.82, ..., 0.27]  (768 floats)             â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚          # Calculate cosine similarity                               â”‚ â”‚
â”‚  â”‚          base_similarity = cosine_similarity(                        â”‚ â”‚
â”‚  â”‚              query_embedding,    # [768 floats]                      â”‚ â”‚
â”‚  â”‚              chunk_embedding     # [768 floats]                      â”‚ â”‚
â”‚  â”‚          )                                                            â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚ â”‚
â”‚  â”‚          â”‚  Cosine Similarity Formula:                â”‚              â”‚ â”‚
â”‚  â”‚          â”‚                                             â”‚              â”‚ â”‚
â”‚  â”‚          â”‚              A Â· B                          â”‚              â”‚ â”‚
â”‚  â”‚          â”‚  similarity = â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                â”‚              â”‚ â”‚
â”‚  â”‚          â”‚              ||A|| Ã— ||B||                 â”‚              â”‚ â”‚
â”‚  â”‚          â”‚                                             â”‚              â”‚ â”‚
â”‚  â”‚          â”‚  Where:                                     â”‚              â”‚ â”‚
â”‚  â”‚          â”‚  A = Query embedding (768D)                â”‚              â”‚ â”‚
â”‚  â”‚          â”‚  B = Chunk embedding (768D)                â”‚              â”‚ â”‚
â”‚  â”‚          â”‚  Â· = Dot product                            â”‚              â”‚ â”‚
â”‚  â”‚          â”‚  ||A|| = Euclidean norm of A               â”‚              â”‚ â”‚
â”‚  â”‚          â”‚                                             â”‚              â”‚ â”‚
â”‚  â”‚          â”‚  Example:                                   â”‚              â”‚ â”‚
â”‚  â”‚          â”‚  dot_product = 0.137                        â”‚              â”‚ â”‚
â”‚  â”‚          â”‚  norm_A = 0.374                             â”‚              â”‚ â”‚
â”‚  â”‚          â”‚  norm_B = 0.370                             â”‚              â”‚ â”‚
â”‚  â”‚          â”‚  similarity = 0.137/(0.374Ã—0.370) = 0.993  â”‚              â”‚ â”‚
â”‚  â”‚          â”‚  Result: 99.3% similar!                     â”‚              â”‚ â”‚
â”‚  â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚  5.2 ğŸš€ Apply Boost Factors                                          â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚      score = base_similarity  # 0.85                                 â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚      # Verified boost (+15%)                                         â”‚ â”‚
â”‚  â”‚      if chunk.verified_by_admin:                                     â”‚ â”‚
â”‚  â”‚          score *= 1.15  # 0.85 â†’ 0.9775                             â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚      # Recency boost (+10% if < 90 days old)                        â”‚ â”‚
â”‚  â”‚      if days_old < 90:                                               â”‚ â”‚
â”‚  â”‚          score *= 1.10  # 0.9775 â†’ 1.07525                          â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚      # Cap at 1.0                                                    â”‚ â”‚
â”‚  â”‚      final_score = min(score, 1.0)  # 1.0                           â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚  5.3 ğŸ¯ Filter by Threshold                                          â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚      if final_score >= threshold:  # 0.7                             â”‚ â”‚
â”‚  â”‚          results.append(chunk)                                       â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚      ğŸ“Š Result: 152 chunks passed threshold                          â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â”‚ results[] (152 chunks)
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚               âœ¨ STEP 6: ENRICH RESULTS WITH METADATA                       â”‚
â”‚               File: app/services/arabic_legal_search_service.py             â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚  6.1 ğŸ” For Each Result                                              â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚      for chunk in results:                                           â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚          enriched = {                                                â”‚ â”‚
â”‚  â”‚              'chunk_id': chunk.id,                                   â”‚ â”‚
â”‚  â”‚              'content': chunk.content,                               â”‚ â”‚
â”‚  â”‚              'similarity': round(score, 4),                          â”‚ â”‚
â”‚  â”‚              'source_type': 'law',                                   â”‚ â”‚
â”‚  â”‚              'verified': chunk.verified_by_admin                     â”‚ â”‚
â”‚  â”‚          }                                                            â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚  6.2 ğŸ“š Fetch Law Source Metadata                                    â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚      law_source = await db.execute(                                  â”‚ â”‚
â”‚  â”‚          SELECT * FROM law_sources                                   â”‚ â”‚
â”‚  â”‚          WHERE id = chunk.law_source_id                              â”‚ â”‚
â”‚  â”‚      )                                                                â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚      enriched['law_metadata'] = {                                    â”‚ â”‚
â”‚  â”‚          'law_id': law.id,                                           â”‚ â”‚
â”‚  â”‚          'law_name': "Ù†Ø¸Ø§Ù… Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ",                           â”‚ â”‚
â”‚  â”‚          'law_type': "law",                                          â”‚ â”‚
â”‚  â”‚          'jurisdiction': "Ø§Ù„Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©",                 â”‚ â”‚
â”‚  â”‚          'issue_date': "1426-08-23"                                  â”‚ â”‚
â”‚  â”‚      }                                                                â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚  6.3 ğŸ“„ Fetch Article Metadata                                       â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚      article = await db.execute(                                     â”‚ â”‚
â”‚  â”‚          SELECT * FROM law_articles                                  â”‚ â”‚
â”‚  â”‚          WHERE id = chunk.article_id                                 â”‚ â”‚
â”‚  â”‚      )                                                                â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚      enriched['article_metadata'] = {                                â”‚ â”‚
â”‚  â”‚          'article_id': article.id,                                   â”‚ â”‚
â”‚  â”‚          'article_number': "74",                                     â”‚ â”‚
â”‚  â”‚          'title': "ÙØ³Ø® Ø¹Ù‚Ø¯ Ø§Ù„Ø¹Ù…Ù„ Ù…Ù† Ù‚Ø¨Ù„ ØµØ§Ø­Ø¨ Ø§Ù„Ø¹Ù…Ù„",                 â”‚ â”‚
â”‚  â”‚          'keywords': ["ÙØ³Ø®", "Ø¹Ù‚Ø¯", "Ø¹Ù…Ù„"]                           â”‚ â”‚
â”‚  â”‚      }                                                                â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚  6.4 ğŸŒ³ Fetch Hierarchy (Branch & Chapter)                           â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚      branch = await db.execute(...)                                  â”‚ â”‚
â”‚  â”‚      chapter = await db.execute(...)                                 â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚      enriched['branch_metadata'] = {                                 â”‚ â”‚
â”‚  â”‚          'branch_number': "Ø§Ù„Ø®Ø§Ù…Ø³",                                  â”‚ â”‚
â”‚  â”‚          'branch_name': "Ø¹Ù„Ø§Ù‚Ø§Øª Ø§Ù„Ø¹Ù…Ù„"                               â”‚ â”‚
â”‚  â”‚      }                                                                â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚      enriched['chapter_metadata'] = {                                â”‚ â”‚
â”‚  â”‚          'chapter_number': "Ø§Ù„Ø«Ø§Ù„Ø«",                                 â”‚ â”‚
â”‚  â”‚          'chapter_name': "Ø¥Ù†Ù‡Ø§Ø¡ Ø¹Ù‚Ø¯ Ø§Ù„Ø¹Ù…Ù„"                           â”‚ â”‚
â”‚  â”‚      }                                                                â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚ â”‚
â”‚  â”‚      â”‚  Hierarchical Structure:                â”‚                     â”‚ â”‚
â”‚  â”‚      â”‚                                          â”‚                     â”‚ â”‚
â”‚  â”‚      â”‚  LawSource (Ù†Ø¸Ø§Ù… Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ)        â”‚                     â”‚ â”‚
â”‚  â”‚      â”‚    â””â”€ Branch (Ø§Ù„Ø¨Ø§Ø¨ Ø§Ù„Ø®Ø§Ù…Ø³)             â”‚                     â”‚ â”‚
â”‚  â”‚      â”‚        â””â”€ Chapter (Ø§Ù„ÙØµÙ„ Ø§Ù„Ø«Ø§Ù„Ø«)        â”‚                     â”‚ â”‚
â”‚  â”‚      â”‚            â””â”€ Article (Ø§Ù„Ù…Ø§Ø¯Ø© 74)       â”‚                     â”‚ â”‚
â”‚  â”‚      â”‚                â””â”€ Chunk (Ø§Ù„Ù†Øµ)          â”‚                     â”‚ â”‚
â”‚  â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â”‚ enriched_results[] (152 chunks)
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚               ğŸ¯ STEP 7: SORT, LIMIT & CACHE                                â”‚
â”‚               File: app/services/arabic_legal_search_service.py             â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚  7.1 ğŸ“Š Sort by Similarity (Descending)                              â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚      enriched_results.sort(                                          â”‚ â”‚
â”‚  â”‚          key=lambda x: x['similarity'],                              â”‚ â”‚
â”‚  â”‚          reverse=True                                                 â”‚ â”‚
â”‚  â”‚      )                                                                â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚      Results:                                                         â”‚ â”‚
â”‚  â”‚      1. similarity: 0.9345                                           â”‚ â”‚
â”‚  â”‚      2. similarity: 0.9123                                           â”‚ â”‚
â”‚  â”‚      3. similarity: 0.8987                                           â”‚ â”‚
â”‚  â”‚      ...                                                              â”‚ â”‚
â”‚  â”‚      152. similarity: 0.7001                                         â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚  7.2 âœ‚ï¸ Limit to top_k                                               â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚      final_results = enriched_results[:top_k]  # [:10]               â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚      ğŸ“Š Result: Top 10 results                                       â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚  7.3 ğŸ’¾ Cache Results                                                â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚      cache_key = "laws_ÙØ³Ø® Ø¹Ù‚Ø¯ Ø§Ù„Ø¹Ù…Ù„_10_0.7_None"                   â”‚ â”‚
â”‚  â”‚      _query_cache[cache_key] = final_results                         â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚      ğŸ’¡ Next time this query comes:                                  â”‚ â”‚
â”‚  â”‚         - Skip Steps 3-7                                             â”‚ â”‚
â”‚  â”‚         - Return immediately in ~20ms                                â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â”‚ Return final_results
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚               ğŸ“¦ STEP 8: FORMAT API RESPONSE                                â”‚
â”‚               File: app/routes/search_router.py                             â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚  8.1 ğŸ¨ Build Response Data                                          â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚      response_data = {                                               â”‚ â”‚
â”‚  â”‚          "query": "ÙØ³Ø® Ø¹Ù‚Ø¯ Ø§Ù„Ø¹Ù…Ù„",                                   â”‚ â”‚
â”‚  â”‚          "results": final_results,  # Array of 10 items              â”‚ â”‚
â”‚  â”‚          "total_results": 10,                                        â”‚ â”‚
â”‚  â”‚          "threshold": 0.7                                            â”‚ â”‚
â”‚  â”‚      }                                                                â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚  8.2 âœ… Create Success Response                                      â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚      return create_success_response(                                 â”‚ â”‚
â”‚  â”‚          message="Found 10 similar laws",                            â”‚ â”‚
â”‚  â”‚          data=response_data                                          â”‚ â”‚
â”‚  â”‚      )                                                                â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â”‚ HTTP 200 OK
                                â”‚ Content-Type: application/json
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚                         ğŸ“± STEP 9: CLIENT RECEIVES RESPONSE                 â”‚
â”‚                                                                             â”‚
â”‚  {                                                                          â”‚
â”‚    "success": true,                                                         â”‚
â”‚    "message": "Found 10 similar laws",                                      â”‚
â”‚    "data": {                                                                â”‚
â”‚      "query": "ÙØ³Ø® Ø¹Ù‚Ø¯ Ø§Ù„Ø¹Ù…Ù„",                                              â”‚
â”‚      "results": [                                                           â”‚
â”‚        {                                                                    â”‚
â”‚          "chunk_id": 123,                                                   â”‚
â”‚          "content": "Ø§Ù„Ù…Ø§Ø¯Ø© 74: ÙŠØ¬ÙˆØ² Ù„ØµØ§Ø­Ø¨ Ø§Ù„Ø¹Ù…Ù„ ÙØ³Ø® Ø§Ù„Ø¹Ù‚Ø¯...",              â”‚
â”‚          "similarity": 0.9345,                                              â”‚
â”‚          "source_type": "law",                                              â”‚
â”‚          "verified": true,                                                  â”‚
â”‚          "law_metadata": {                                                  â”‚
â”‚            "law_name": "Ù†Ø¸Ø§Ù… Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ",                                â”‚
â”‚            "law_type": "law",                                               â”‚
â”‚            "jurisdiction": "Ø§Ù„Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©"                       â”‚
â”‚          },                                                                 â”‚
â”‚          "article_metadata": {                                              â”‚
â”‚            "article_number": "74",                                          â”‚
â”‚            "title": "ÙØ³Ø® Ø¹Ù‚Ø¯ Ø§Ù„Ø¹Ù…Ù„ Ù…Ù† Ù‚Ø¨Ù„ ØµØ§Ø­Ø¨ Ø§Ù„Ø¹Ù…Ù„"                      â”‚
â”‚          },                                                                 â”‚
â”‚          "branch_metadata": { ... },                                        â”‚
â”‚          "chapter_metadata": { ... }                                        â”‚
â”‚        }                                                                    â”‚
â”‚        // ... 9 more results                                                â”‚
â”‚      ],                                                                     â”‚
â”‚      "total_results": 10,                                                   â”‚
â”‚      "threshold": 0.7                                                       â”‚
â”‚    },                                                                       â”‚
â”‚    "errors": []                                                             â”‚
â”‚  }                                                                          â”‚
â”‚                                                                             â”‚
â”‚  â±ï¸  Total Time:                                                            â”‚
â”‚      First Request: 500-2000ms                                              â”‚
â”‚      Cached Request: ~20ms                                                  â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ Key Points Summary

### Step 1: API Gateway (10ms)
- âœ… JWT authentication
- âœ… Parameter validation
- âœ… Build filters

### Step 2: Check Cache (2ms)
- ğŸ’¾ Cache hit? â†’ Return instantly (20ms total)
- âŒ Cache miss? â†’ Continue to Step 3

### Step 3: Generate Query Embedding (50-100ms)
- ğŸ¤– Use AI model (768-dimensional BERT)
- ğŸ’¾ Cache embedding for future use
- ğŸ“Š Output: [768 float numbers]

### Step 4: Database Query (50-200ms)
- ğŸ“Š Get all law chunks with embeddings
- ğŸ¯ Apply filters if provided
- ğŸ“¦ Result: 600 chunks

### Step 5: Calculate Similarities (200-800ms)
- ğŸ§® Cosine similarity for each chunk
- ğŸš€ Apply boost factors (verified +15%, recent +10%)
- ğŸ¯ Filter by threshold (â‰¥ 0.7)
- ğŸ“Š Result: 152 matching chunks

### Step 6: Enrich with Metadata (100-500ms)
- ğŸ“š Fetch law source info
- ğŸ“„ Fetch article details
- ğŸŒ³ Fetch hierarchy (branch, chapter)
- âœ¨ Build complete result objects

### Step 7: Sort, Limit & Cache (5ms)
- ğŸ“Š Sort by similarity (descending)
- âœ‚ï¸ Limit to top_k (10 results)
- ğŸ’¾ Cache for future queries

### Step 8: Format Response (5ms)
- ğŸ¨ Build standardized JSON
- âœ… Success response
- ğŸ“¦ Return to client

### Step 9: Client Receives (Network time)
- ğŸ“± HTTP 200 OK
- ğŸ“¦ Complete results with all metadata
- ğŸ‰ Ready to display!

---

## ğŸ“Š Performance Timeline

```
Time    Component                  Action                    Duration
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
T+0ms   Client                    Send Request              -
T+10ms  API Gateway               Authenticate & Validate   10ms
T+12ms  Search Service            Check Cache               2ms (MISS)
T+15ms  Embedding Service         Check Embedding Cache     3ms (MISS)
T+65ms  AI Model                  Generate Embedding        50ms
T+70ms  Search Service            Build Database Query      5ms
T+220ms Database                  Execute Query             150ms
T+820ms Search Service            Calculate Similarities    600ms
T+1220ms Database                 Enrich Metadata           400ms
T+1225ms Search Service           Sort & Limit              5ms
T+1230ms Search Service           Cache Results             5ms
T+1235ms API Gateway              Format Response           5ms
T+1240ms Client                   Receive Response          -
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

TOTAL TIME: 1240ms (First Request)
```

```
Time    Component                  Action                    Duration
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
T+0ms   Client                    Send Request              -
T+10ms  API Gateway               Authenticate & Validate   10ms
T+12ms  Search Service            Check Cache               2ms (HIT!)
T+15ms  API Gateway               Format Response           3ms
T+20ms  Client                    Receive Response          -
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

TOTAL TIME: 20ms (Cached Request - 62x faster!)
```

---

## ğŸ¨ Data Flow Visualization

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Query     â”‚
â”‚ "ÙØ³Ø® Ø¹Ù‚Ø¯"    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     AI Model Transform        â”‚
â”‚  768-dimensional embedding    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   [0.123, -0.456, ..., 0.234]â”‚ â—„â”€â”€â”€ Query Vector
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ Compare with
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Database (600 law chunks)              â”‚
â”‚                                             â”‚
â”‚  Chunk 1: [0.15, -0.48, ..., 0.27] â†’ 0.93  â”‚ âœ…
â”‚  Chunk 2: [0.11, -0.42, ..., 0.31] â†’ 0.89  â”‚ âœ…
â”‚  Chunk 3: [0.08, -0.52, ..., 0.19] â†’ 0.76  â”‚ âœ…
â”‚  ...                                        â”‚
â”‚  Chunk 600: [0.02, -0.61, ..., 0.05] â†’ 0.45â”‚ âŒ
â”‚                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â”‚ Filter (â‰¥ 0.7)
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   152 matching chunks           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â”‚ Enrich Metadata
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Complete Results with Hierarchy          â”‚
â”‚                                            â”‚
â”‚   [Law â†’ Branch â†’ Chapter â†’ Article â†’ Text]â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â”‚ Sort & Limit (top 10)
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Final Response              â”‚
â”‚   10 best-matching laws         â”‚
â”‚   with complete metadata        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**Created**: October 9, 2025  
**Purpose**: Visual flow diagram for similar-laws endpoint  
**Companion Document**: SIMILAR_LAWS_COMPLETE_EXPLANATION.md

