# ูุธุงู ุฑูุน ููุนุงูุฌุฉ ุงููุซุงุฆู ุงููุงููููุฉ ูุน ุฏุนู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงููุฒุฏูุฌุฉ

## ูุธุฑุฉ ุนุงูุฉ

ุชู ุชุทููุฑ ูุธุงู ุดุงูู ูุฑูุน ููุนุงูุฌุฉ ุงููุซุงุฆู ุงููุงููููุฉ ูุฏุนู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงููุฒุฏูุฌุฉ (SQL + Chroma Vectorstore) ูุน ุถูุงู ุงูุชุฒุงูู ุงููุงูู ุจููููุง.

## ุงูููุฒุงุช ุงูุฑุฆูุณูุฉ

### ๐ ุฏุนู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงููุฒุฏูุฌุฉ
- **ูุงุนุฏุฉ ุงูุจูุงูุงุช SQL**: ุชุฎุฒูู ุงูุจูุงูุงุช ุงูููุธูุฉ ูุงูุนูุงูุงุช
- **Chroma Vectorstore**: ุชุฎุฒูู ุงูู embeddings ููุจุญุซ ุงูุฏูุงูู
- **ุงูุชุฒุงูู ุงูุชููุงุฆู**: ุฌููุน ุงูุนูููุงุช ุชุชู ูู ููุง ุงููุธุงููู ูุนูุง

### ๐ฏ Singleton Pattern
- **VectorstoreManager**: ุฅุฏุงุฑุฉ ููุญุฏุฉ ููู embeddings ู Chroma
- **ููุน ุงูุชูุฑุงุฑ**: ุถูุงู ูุฌูุฏ ูุณุฎุฉ ูุงุญุฏุฉ ููุท ูู ูู ูููู
- **ุชุญุณูู ุงูุฃุฏุงุก**: ุชูููู ููุช ุงูุชุญููู ูุงูุฐุงูุฑุฉ

### ๐ก๏ธ ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก ุงููุชูุฏูุฉ
- **Rollback ุชููุงุฆู**: ูู ุญุงูุฉ ูุดู ุฃู ุนูููุฉ
- **ุงูุชุฒุงูู ุงููุถููู**: ุฅูุง ูุฌุงุญ ุงูุนูููุฉ ูู ููุง ุงููุธุงููู ุฃู ูุดููุง
- **ุณุฌูุงุช ููุตูุฉ**: ุชุชุจุน ุฌููุน ุงูุนูููุงุช ูุงูุฃุฎุทุงุก

### ๐ง ุงููุฑููุฉ ูู ุงูุฅุฏุงุฑุฉ
- **ุญุฐู ูุฑู**: ูููู ุญุฐู ุฃู ุฌุฏูู ุจุฏูู ูุณุฑ ูุธุงู RAG
- **ุชุญุฏูุซ ูุชุฒุงูู**: ุชุญุฏูุซ ุงููุญุชูู ูู ููุง ุงููุธุงููู
- **ูุฒุงููุฉ ูุฏููุฉ**: ุฅููุงููุฉ ูุฒุงููุฉ ุงููุธุงููู ุนูุฏ ุงูุญุงุฌุฉ

## ุงูุจููุฉ ุงูุชูููุฉ

### 1. VectorstoreManager (Singleton)
```python
class VectorstoreManager:
    """
    ูุฏูุฑ ููุญุฏ ููู Chroma vectorstore ูุงูู embeddings
    ูุถูู ูุฌูุฏ ูุณุฎุฉ ูุงุญุฏุฉ ููุท ูู ูู ูููู
    """
```

**ุงูููููุงุช:**
- `embeddings`: ูููุฐุฌ ุงูู embeddings (GATE-AraBert-v1)
- `vectorstore`: ูุซูู Chroma ููุจุญุซ ุงูุฏูุงูู
- `text_splitter`: ููุณู ุงููุตูุต ููู chunks

### 2. DualDatabaseManager
```python
class DualDatabaseManager:
    """
    ูุฏูุฑ ุงูุนูููุงุช ุงููุชุฒุงููุฉ ุจูู SQL ู Chroma
    ูุถูู ุงูุชุฒุงูู ุงููุงูู ูุงูู rollback ุงูุชููุงุฆู
    """
```

**ุงููุธุงุฆู ุงูุฑุฆูุณูุฉ:**
- `add_chunk_to_both_databases()`: ุฅุถุงูุฉ chunk ูููุง ุงููุธุงููู
- `update_chunk_in_both_databases()`: ุชุญุฏูุซ chunk ูู ููุง ุงููุธุงููู
- `delete_chunk_from_both_databases()`: ุญุฐู chunk ูู ููุง ุงููุธุงููู
- `sync_database_states()`: ูุฒุงููุฉ ุญุงูุฉ ุงููุธุงููู

### 3. LegalDocumentParser (ูุญุฏุซ)
```python
class LegalDocumentParser:
    """
    ูุญูู ุงููุซุงุฆู ุงููุงููููุฉ ูุน ุฏุนู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงููุฒุฏูุฌุฉ
    """
```

**ุงูุชุญุณููุงุช:**
- ุงุณุชุฎุฏุงู `DualDatabaseManager` ูุฌููุน ุงูุนูููุงุช
- metadata ูุญุณู ููู Chroma
- ูุนุงูุฌุฉ ุฃุฎุทุงุก ูุชูุฏูุฉ

### 4. DocumentUploadService (ูุญุฏุซ)
```python
class DocumentUploadService:
    """
    ุฎุฏูุฉ ุฑูุน ุงููุซุงุฆู ูุน ุฅุฏุงุฑุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงููุฒุฏูุฌุฉ
    """
```

**ุงููุธุงุฆู ุงูุฌุฏูุฏุฉ:**
- `update_chunk_content()`: ุชุญุฏูุซ ูุญุชูู chunk
- `delete_chunk()`: ุญุฐู chunk
- `delete_document()`: ุญุฐู ูุซููุฉ ูุงููุฉ
- `sync_databases()`: ูุฒุงููุฉ ุงููุธุงููู
- `get_database_status()`: ุญุงูุฉ ุงููุธุงููู

## API Endpoints ุงูุฌุฏูุฏุฉ

### ๐ ุฅุฏุงุฑุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช
```http
GET /api/v1/documents/database/status
```
**ุงูุงุณุชุฌุงุจุฉ:**
```json
{
  "success": true,
  "data": {
    "sql_database": {
      "documents": 5,
      "law_sources": 3,
      "articles": 150,
      "chunks": 450
    },
    "chroma_database": {
      "chunks": 450
    },
    "synchronization": {
      "sql_chunks": 450,
      "chroma_chunks": 450,
      "sync_status": "synchronized"
    }
  }
}
```

### ๐ ูุฒุงููุฉ ุงููุธุงููู
```http
POST /api/v1/documents/database/sync
```

### โ๏ธ ุชุญุฏูุซ Chunk
```http
PUT /api/v1/documents/chunks/{chunk_id}
Content-Type: multipart/form-data

new_content=ุงููุญุชูู ุงูุฌุฏูุฏ
new_metadata={"keywords": ["ูุงููู", "ุนูู"]}
```

### ๐๏ธ ุญุฐู Chunk
```http
DELETE /api/v1/documents/chunks/{chunk_id}
```

### ๐๏ธ ุญุฐู ูุซููุฉ ูุงููุฉ
```http
DELETE /api/v1/documents/documents/{document_id}
```

## Metadata ูู Chroma

ูู chunk ูู Chroma ูุญุชูู ุนูู metadata ุดุงูู:

```json
{
  "document_id": 123,
  "chunk_id": 456,
  "chunk_index": 0,
  "tokens_count": 150,
  "verified_by_admin": false,
  "created_at": "2024-01-15T10:30:00",
  "law_source_id": 789,
  "article_id": 101,
  "article_number": "ุงููุงุฏุฉ 1",
  "article_title": "ุชุนุฑููุงุช",
  "law_name": "ูุธุงู ุงูุนูู",
  "law_type": "law",
  "jurisdiction": "ุงูููููุฉ ุงูุนุฑุจูุฉ ุงูุณุนูุฏูุฉ",
  "issuing_authority": "ููู ุงูููููุฉ ุงูุนุฑุจูุฉ ุงูุณุนูุฏูุฉ",
  "issue_date": "2023-01-01",
  "document_title": "ูุธุงู ุงูุนูู ุงูุณุนูุฏู",
  "document_category": "law",
  "keywords": ["ุนูู", "ููุธู", "ุฑุงุชุจ"]
}
```

## ุณูุฑ ุงูุนูู (Workflow)

### 1. ุฑูุน ูุซููุฉ ุฌุฏูุฏุฉ
```
1. ุงูุชุญูู ูู ุตุญุฉ ุงูููู
2. ุญูุธ ุงูููู ูุญุณุงุจ ุงูู hash
3. ุฅูุดุงุก ุณุฌู KnowledgeDocument ูู SQL
4. ุชุญููู ุงููุญุชูู (JSON parsing)
5. ุฅูุดุงุก LawSource ู LawArticle ูู SQL
6. ุชูุณูู ุงููุตูุต ุฅูู chunks
7. ุญูุธ ูู chunk ูู SQL ู Chroma ูุนูุง
8. ุชุญุฏูุซ ุญุงูุฉ ุงููุซููุฉ ุฅูู 'processed'
```

### 2. ุชุญุฏูุซ chunk
```
1. ุงูุชุญูู ูู ูุฌูุฏ chunk ูู SQL
2. ุชุญุฏูุซ ุงููุญุชูู ูู SQL
3. ุญุฐู chunk ุงููุฏูู ูู Chroma
4. ุฅุถุงูุฉ chunk ุงูุฌุฏูุฏ ุฅูู Chroma
5. ุงูุชุฃูุฏ ูู ูุฌุงุญ ุงูุนูููุฉ ูู ููุง ุงููุธุงููู
```

### 3. ุญุฐู ูุซููุฉ
```
1. ุงูุญุตูู ุนูู ุฌููุน chunks ูููุซููุฉ
2. ุญุฐู ุฌููุน chunks ูู Chroma
3. ุญุฐู ุงููุซููุฉ ูู SQL (cascade ุณูุชููู chunks)
4. ุงูุชุฃูุฏ ูู ูุฌุงุญ ุงูุนูููุฉ
```

## ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก

### Rollback ุงูุชููุงุฆู
```python
try:
    # ุฅุถุงูุฉ ุฅูู SQL
    self.db.add(chunk)
    await self.db.commit()
    
    # ุฅุถุงูุฉ ุฅูู Chroma
    self.vectorstore.add_texts(...)
    
except Exception as e:
    # Rollback ุชููุงุฆู
    await self.db.rollback()
    logger.error(f"โ Failed: {e}")
    return False
```

### ุงูุชุฒุงูู ุงููุถููู
- ุฅูุง ูุฌุงุญ ุงูุนูููุฉ ูู ููุง ุงููุธุงููู
- ุฃู ูุดููุง ูุน rollback ูุงูู
- ูุง ุชูุฌุฏ ุญุงูุฉ ูุณุทู

## ุงูุฃุฏุงุก ูุงูุชุญุณููุงุช

### ุชุญุณููุงุช ุงูุฐุงูุฑุฉ
- **Singleton Pattern**: ููุน ุชูุฑุงุฑ ุงูููุงุฐุฌ
- **Batch Processing**: ูุนุงูุฌุฉ chunks ูู ูุฌููุนุงุช
- **Lazy Loading**: ุชุญููู ุงูููุงุฐุฌ ุนูุฏ ุงูุญุงุฌุฉ ููุท

### ุชุญุณููุงุช ุงูุณุฑุนุฉ
- **Persistent Storage**: Chroma ูุญูุธ ุงูุจูุงูุงุช ุชููุงุฆูุงู
- **Indexed Queries**: ููุงุฑุณ ูุญุณูุฉ ูู SQL
- **Connection Pooling**: ุฅุฏุงุฑุฉ ุงุชุตุงูุงุช ูุงุนุฏุฉ ุงูุจูุงูุงุช

## ุงูุงุฎุชุจุงุฑ ูุงูุชุญูู

### ุงุฎุชุจุงุฑ ุงูุชุฒุงูู
```python
# ุงุฎุชุจุงุฑ ุฅุถุงูุฉ chunk
chunk_id = await add_chunk_to_both_databases(...)
assert chunk_exists_in_sql(chunk_id)
assert chunk_exists_in_chroma(chunk_id)
```

### ุงุฎุชุจุงุฑ Rollback
```python
# ูุญุงููุฉ ุฅุถุงูุฉ chunk ูุน ุฎุทุฃ ูู Chroma
with pytest.raises(Exception):
    await add_chunk_to_both_databases(invalid_chunk)
assert not chunk_exists_in_sql(chunk_id)
```

## ุงูุชุทููุฑ ุงููุณุชูุจูู

### ุฏุนู ุฃููุงุน ูููุงุช ุฅุถุงููุฉ
- **PDF**: ุงุณุชุฎุฑุงุฌ ุงููุตูุต ูุชุญููู ุงูุชุฎุทูุท
- **DOCX**: ูุนุงูุฌุฉ ูุณุชูุฏุงุช Word
- **TXT**: ุชุญููู ุงููุตูุต ุงูุนุงุฏูุฉ

### ุชุญุณููุงุช ุงูุจุญุซ
- **Hybrid Search**: ุฏูุฌ ุงูุจุญุซ ุงููุตู ูุงูุฏูุงูู
- **Reranking**: ุฅุนุงุฏุฉ ุชุฑุชูุจ ุงููุชุงุฆุฌ
- **Multi-language**: ุฏุนู ูุบุงุช ูุชุนุฏุฏุฉ

### ุชุญุณููุงุช ุงูุฅุฏุงุฑุฉ
- **Batch Operations**: ุนูููุงุช ูุฌูุนุฉ
- **Versioning**: ุฅุฏุงุฑุฉ ุฅุตุฏุงุฑุงุช ุงููุซุงุฆู
- **Audit Trail**: ุชุชุจุน ุฌููุน ุงูุชุบููุฑุงุช

## ุงูุงุณุชุฎุฏุงู

### ุฑูุน ูุซููุฉ ุฌุฏูุฏุฉ
```bash
curl -X POST "http://localhost:8000/api/v1/documents/upload" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -F "file=@document.json" \
  -F "title=ูุธุงู ุงูุนูู" \
  -F "category=law"
```

### ูุญุต ุญุงูุฉ ุงููุธุงููู
```bash
curl -X GET "http://localhost:8000/api/v1/documents/database/status"
```

### ูุฒุงููุฉ ุงููุธุงููู
```bash
curl -X POST "http://localhost:8000/api/v1/documents/database/sync"
```

## ุงูุฎูุงุตุฉ

ุชู ุชุทููุฑ ูุธุงู ุดุงูู ููุชุทูุฑ ูุฑูุน ููุนุงูุฌุฉ ุงููุซุงุฆู ุงููุงููููุฉ ูุน ุฏุนู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงููุฒุฏูุฌุฉ. ุงููุธุงู ูุถูู:

โ **ุงูุชุฒุงูู ุงููุงูู** ุจูู SQL ู Chroma  
โ **ูุนุงูุฌุฉ ุฃุฎุทุงุก ูุชูุฏูุฉ** ูุน rollback ุชููุงุฆู  
โ **ูุฑููุฉ ูู ุงูุฅุฏุงุฑุฉ** ูุน ุฅููุงููุฉ ุงูุญุฐู ูุงูุชุญุฏูุซ  
โ **ุฃุฏุงุก ูุญุณู** ุจุงุณุชุฎุฏุงู Singleton Pattern  
โ **API ุดุงูู** ูุฌููุน ุงูุนูููุงุช  
โ **ุชูุซูู ููุตู** ูุงุฎุชุจุงุฑุงุช ุดุงููุฉ  

ุงููุธุงู ุฌุงูุฒ ููุงุณุชุฎุฏุงู ุงูููุฑู ููููู ุชูุณูุนู ุจุณูููุฉ ูุฏุนู ุฃููุงุน ูููุงุช ุฅุถุงููุฉ ูููุฒุงุช ูุชูุฏูุฉ.
